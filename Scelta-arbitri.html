<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selezione Arbitri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="container max-w-lg mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-200">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Selezione Arbitri</h1>
            <p id="todayDate" class="text-gray-500 text-sm"></p>
        </header>

        <main>
            <div id="selectionArea">
                <div class="mb-4">
                    <label for="nickname" class="block text-gray-700 font-semibold mb-2">Inserisci il tuo nome o nickname:</label>
                    <input type="text" id="nickname" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Es. MarioR7">
                </div>

                <p class="text-lg text-center text-gray-700 mb-4">Scegli i tuoi 3 arbitri preferiti per la giornata:</p>
                
                <div class="relative mb-6">
                    <ul id="refereesList" class="space-y-3">
                        <!-- Referee list will be populated by JavaScript -->
                    </ul>
                </div>

                <div id="captainSelectionArea" class="hidden mb-6">
                    <p class="text-lg text-center text-gray-700 mb-4">Scegli uno dei 3 arbitri selezionati come "capitano":</p>
                    <ul id="captainList" class="space-y-3">
                        <!-- Captain list will be populated by JavaScript -->
                    </ul>
                </div>
    
                <div id="messageBox" class="text-center py-3 rounded-lg text-sm transition-opacity duration-300 opacity-0"></div>
    
                <button id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Invia le mie scelte
                </button>
            </div>
            
            <div id="loadingIndicator" class="hidden text-center text-blue-600 font-semibold mt-4">
                Caricamento in corso...
            </div>
            
            <div id="successArea" class="hidden text-center mt-6">
                <h2 class="text-2xl font-bold text-green-600 mb-2">Grazie!</h2>
                <p class="text-gray-700">Le tue scelte sono state registrate con successo.</p>
            </div>
        </main>
        
        <hr class="my-8 border-t border-gray-200">

        <!-- Live Results Section -->
        <section>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Risultati in tempo reale</h3>
            <div id="resultsList" class="space-y-2">
                <!-- Live results will be populated by JavaScript -->
                <p id="noResults" class="text-gray-500 text-sm italic">Nessuna selezione ancora.</p>
            </div>
        </section>
    </div>

    <script type="module">
        // La funzione per inizializzare l'app viene chiamata solo quando il DOM è completamente caricato.
        window.addEventListener('DOMContentLoaded', async () => {

            // Firebase and Firestore imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // Global variables for Firebase configuration, provided by the environment
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            const referees = [
                "Mario Rossi", "Luca Bianchi", "Giovanni Russo", "Marco Esposito",
                "Antonio Romano", "Francesco Gallo", "Giuseppe Conti",
                "Federico Moretti", "Alessandro Ferri", "Matteo Riccardi"
            ];

            let selectedReferees = [];
            let selectedCaptain = null;
            let userId = null;

            // DOM elements
            const nicknameInput = document.getElementById('nickname');
            const refereesListEl = document.getElementById('refereesList');
            const captainSelectionArea = document.getElementById('captainSelectionArea');
            const captainListEl = document.getElementById('captainList');
            const submitBtn = document.getElementById('submitBtn');
            const messageBox = document.getElementById('messageBox');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const successArea = document.getElementById('successArea');
            const selectionArea = document.getElementById('selectionArea');
            const resultsListEl = document.getElementById('resultsList');
            const noResultsMessage = document.getElementById('noResults');
            const todayDateEl = document.getElementById('todayDate');

            // Set today's date
            const today = new Date();
            const formattedDate = new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: 'long', year: 'numeric' }).format(today);
            todayDateEl.textContent = formattedDate;

            // Function to show a message box
            function showMessage(text, type = 'error') {
                messageBox.textContent = text;
                messageBox.style.opacity = '1';
                if (type === 'success') {
                    messageBox.classList.remove('bg-red-100', 'text-red-700');
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                } else {
                    messageBox.classList.remove('bg-green-100', 'text-red-700');
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                }
                // Hide the message after 3 seconds
                setTimeout(() => {
                    messageBox.style.opacity = '0';
                }, 3000);
            }

            // Function to update the captain selection list
            function updateCaptainSelectionList() {
                captainListEl.innerHTML = '';
                selectedCaptain = null;
                selectedReferees.forEach(name => {
                    const li = document.createElement('li');
                    li.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200";
                    li.innerHTML = `<span class="text-gray-800">${name}</span>`;
                    li.dataset.name = name;
                    li.addEventListener('click', () => {
                        // Deselect any previously selected captain
                        captainListEl.querySelectorAll('li').forEach(item => {
                            item.classList.remove('bg-green-100', 'ring-2', 'ring-green-500');
                        });
                        
                        // Select the new captain
                        li.classList.add('bg-green-100', 'ring-2', 'ring-green-500');
                        selectedCaptain = name;
                        updateSubmitButtonState();
                    });
                    captainListEl.appendChild(li);
                });
            }

            // Populate the list of referees
            referees.forEach(name => {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200";
                li.innerHTML = `
                    <span class="text-gray-800">${name}</span>
                    <span class="text-gray-400 text-xs check-icon">Scegli</span>
                `;
                li.dataset.name = name;
                li.addEventListener('click', () => {
                    if (li.classList.contains('bg-blue-100')) {
                        // Deselect
                        li.classList.remove('bg-blue-100');
                        li.querySelector('.check-icon').textContent = 'Scegli';
                        selectedReferees = selectedReferees.filter(ref => ref !== name);
                    } else {
                        // Select
                        if (selectedReferees.length < 3) {
                            li.classList.add('bg-blue-100');
                            li.querySelector('.check-icon').textContent = 'Selezionato';
                            selectedReferees.push(name);
                        } else {
                            showMessage('Puoi scegliere un massimo di 3 arbitri.');
                        }
                    }
                    
                    // Show/hide captain selection area
                    if (selectedReferees.length === 3) {
                        captainSelectionArea.classList.remove('hidden');
                        updateCaptainSelectionList();
                    } else {
                        captainSelectionArea.classList.add('hidden');
                        selectedCaptain = null;
                    }
                    updateSubmitButtonState();
                });
                refereesListEl.appendChild(li);
            });

            // Function to enable/disable the submit button
            function updateSubmitButtonState() {
                const isFormValid = selectedReferees.length === 3 && selectedCaptain !== null && nicknameInput.value.trim() !== '';
                submitBtn.disabled = !isFormValid;
                if (submitBtn.disabled) {
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }

            // Submit button click handler
            submitBtn.addEventListener('click', async () => {
                const nickname = nicknameInput.value.trim();
                if (selectedReferees.length !== 3 || selectedCaptain === null || nickname === '') {
                    showMessage('Devi scegliere esattamente 3 arbitri, un capitano e inserire il tuo nome/nickname.');
                    return;
                }

                loadingIndicator.classList.remove('hidden');
                submitBtn.disabled = true;

                try {
                    // Check if the user has already submitted for today
                    const userSelectionsRef = collection(db, `artifacts/${appId}/public/data/referee-selections`);
                    const userQuery = query(userSelectionsRef, where("userId", "==", userId));
                    const userDocs = await getDocs(userQuery);
                    const todayFormatted = new Date().toISOString().slice(0, 10);
                    let hasSubmittedToday = false;
                    userDocs.forEach(doc => {
                        const data = doc.data();
                        if (data.date === todayFormatted) {
                            hasSubmittedToday = true;
                        }
                    });

                    if (hasSubmittedToday) {
                        showMessage('Hai già inviato le tue scelte per oggi.');
                        loadingIndicator.classList.add('hidden');
                        submitBtn.disabled = false;
                        return;
                    }

                    // Add the new selection to Firestore
                    await addDoc(userSelectionsRef, {
                        userId: userId,
                        nickname: nickname,
                        date: todayFormatted,
                        selection: selectedReferees,
                        captain: selectedCaptain,
                        timestamp: new Date()
                    });

                    // Show success message and hide selection area
                    selectionArea.classList.add('hidden');
                    successArea.classList.remove('hidden');

                } catch (e) {
                    console.error("Errore durante l'invio delle scelte:", e);
                    showMessage("Si è verificato un errore. Riprova più tardi.", 'error');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            });

            // Real-time results listener
            const unsubscribe = onSnapshot(collection(db, `artifacts/${appId}/public/data/referee-selections`), (snapshot) => {
                const allSelections = [];
                const refereeCounts = {};
                const captainCounts = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.selection) {
                        data.selection.forEach(referee => {
                            refereeCounts[referee] = (refereeCounts[referee] || 0) + 1;
                        });
                    }
                    if (data.captain) {
                        captainCounts[data.captain] = (captainCounts[data.captain] || 0) + 1;
                    }
                });

                // Clear previous results
                resultsListEl.innerHTML = '';

                // Get sorted referee names
                const sortedReferees = referees.sort((a, b) => {
                    const countA = refereeCounts[a] || 0;
                    const countB = refereeCounts[b] || 0;
                    return countB - countA;
                });
                
                // Populate the results list
                if (Object.keys(refereeCounts).length > 0) {
                    noResultsMessage.classList.add('hidden');
                    sortedReferees.forEach(name => {
                        const count = refereeCounts[name] || 0;
                        const captainCount = captainCounts[name] || 0;
                        const resultItem = document.createElement('div');
                        resultItem.className = "flex items-center justify-between text-gray-700 text-sm py-2 px-3 bg-gray-50 rounded-lg";
                        resultItem.innerHTML = `
                            <span class="font-semibold">${name}</span>
                            <div class="flex items-center space-x-4">
                                <span>Voti: <span class="font-bold">${count}</span></span>
                                <span>Capitano: <span class="font-bold">${captainCount}</span></span>
                            </div>
                        `;
                        resultsListEl.appendChild(resultItem);
                    });
                } else {
                    noResultsMessage.classList.remove('hidden');
                }
            });

            // Initialize authentication
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).then(userCredential => {
                    userId = userCredential.user.uid;
                    updateSubmitButtonState();
                }).catch(error => {
                    console.error("Errore nell'autenticazione con token personalizzato:", error);
                    signInAnonymously(auth).then(userCredential => {
                        userId = userCredential.user.uid;
                        updateSubmitButtonState();
                    });
                });
            } else {
                signInAnonymously(auth).then(userCredential => {
                    userId = userCredential.user.uid;
                    updateSubmitButtonState();
                });
            }
        });
    </script>
</body>
</html>
